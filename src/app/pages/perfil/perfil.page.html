<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <ion-card *ngIf="usuario" class="perfil-card">
    <ion-card-header class="perfil-header">
      <ion-avatar class="perfil-avatar">
        <ion-icon name="person-circle-outline" size="large"></ion-icon>
      </ion-avatar>
      <ion-card-title>{{ usuario.username }}</ion-card-title>
      <ion-card-subtitle>{{ usuario.role }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Email:</strong> {{ usuario.email || 'No registrado' }}</p>
      <p><strong>Estado:</strong> {{ usuario.isactive ? 'Activo' : 'Inactivo' }}</p>
    </ion-card-content>
  </ion-card>

<ion-card>
  <ion-card-header>
    <ion-card-title>√Årboles de Conocimiento</ion-card-title>
    <ion-card-subtitle>Promedio (√∫ltimos 3 ex√°menes)</ion-card-subtitle>
  </ion-card-header>

  <ion-card-content>
    <h3 class="fortalezas-title">Fortalezas üí™</h3>
    <div *ngIf="fortalezas.length > 0; else noFortalezas" class="arbol-grid">
      <div *ngFor="let arbol of fortalezas" class="arbol-cell fortaleza" (click)="irArbol(arbol.nombre)">
        <div class="arbol-nombre">{{ arbol.nombre }}</div>
        <div class="porcentaje">{{ arbol.porcentajeAciertos | number:'1.0-0' }}%</div>
        <ion-progress-bar [value]="arbol.porcentajeAciertos / 100" color="success"></ion-progress-bar>
      </div>
    </div>
    <ng-template #noFortalezas>
      <p class="ion-text-center">A√∫n no tienes fortalezas destacadas.</p>
    </ng-template>

    <h3 class="debilidades-title">Debilidades ‚ö†Ô∏è</h3>
    <div *ngIf="debilidades.length > 0; else noDebilidades" class="arbol-grid">
      <div *ngFor="let arbol of debilidades" class="arbol-cell debilidad" (click)="irArbol(arbol.nombre)">
        <div class="arbol-nombre">{{ arbol.nombre }}</div>
        <div class="porcentaje">{{ arbol.porcentajeAciertos | number:'1.0-0' }}%</div>
        <ion-progress-bar [value]="arbol.porcentajeAciertos / 100" color="danger"></ion-progress-bar>
      </div>
    </div>
    <ng-template #noDebilidades>
      <p class="ion-text-center">¬°Excelente! No tienes debilidades registradas.</p>
    </ng-template>
  </ion-card-content>
</ion-card>



  <ion-card *ngIf="cursos.length > 0">
    <ion-card-header>
      <ion-card-title>Cursos Realizados</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-card *ngFor="let curso of cursos" class="intento-card">
          <ion-card-header>
            <ion-card-title>{{ curso.title }}</ion-card-title>
            <ion-card-subtitle>
              Progreso: {{ curso.progreso | number:'1.0-0' }}%
              <ion-progress-bar [value]="curso.progreso / 100" color="success"></ion-progress-bar>
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-button expand="block" size="small" color="primary" (click)="toggleDetalleCurso(curso)">
              {{ curso.mostrarDetalle ? 'Ocultar' : 'Examinar' }}
            </ion-button>
            <ng-container *ngIf="curso.mostrarDetalle">
              <ion-list>
                <ion-item *ngFor="let l of curso.lessons">
                  <ion-label>
                    {{ l.titulo }} - 
                    <span [ngClass]="{ 'correcta': l.completed, 'incorrecta': !l.completed }">
                      {{ l.completed ? 'Aprendida' : 'No aprendida' }}
                    </span>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ng-container>
          </ion-card-content>
        </ion-card>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="intentos.length > 0">
    <ion-card-header>
      <ion-card-title>Ex√°menes Realizados</ion-card-title>
      <ion-card-subtitle>
        <ion-button expand="block" size="small" color="danger" (click)="eliminarTodosExamenes()">
          Borrar todos los ex√°menes
        </ion-button>
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-card *ngFor="let intento of intentos; let i = index" class="intento-card">
          <ion-card-header>
            <ion-card-title>{{ intento.fechaFormateada }}</ion-card-title>
            <ion-card-subtitle>
              Puntaje: {{ intento.puntaje | number:'1.0-0' }}%
              <ion-progress-bar [value]="intento.puntaje / 100" color="success"></ion-progress-bar>
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <ion-button expand="block" size="small" color="primary" (click)="toggleDetalleExamen(intento)">
              {{ intento.mostrarDetalle ? 'Ocultar' : 'Examinar' }}
            </ion-button>
            <ion-button expand="block" size="small" color="danger" (click)="eliminarExamen(i)">
              Eliminar este examen
            </ion-button>

            <ng-container *ngIf="intento.mostrarDetalle">
              <ion-list>
                <ion-item *ngFor="let r of intento.respuestas">
                  <ion-label>
                    <strong>{{ r.texto }}</strong>
                    <ion-list>
                      <ion-item *ngFor="let o of r.opciones; let j = index"
                                [ngClass]="{
                                  'correcta': j === r.correcta,
                                  'incorrecta': j === r.seleccion && j !== r.correcta
                                }">
                        {{ o }}
                      </ion-item>
                    </ion-list>
                  </ion-label>
                </ion-item>
              </ion-list>
            </ng-container>
          </ion-card-content>
        </ion-card>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="cursos.length === 0 && intentos.length === 0">
    <ion-card-content>
      <p>No tienes cursos ni ex√°menes registrados a√∫n.</p>
    </ion-card-content>
  </ion-card>

</ion-content>
