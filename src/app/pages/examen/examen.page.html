<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Examen Te√≥rico</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <!-- Reglas antes del examen -->
  <ion-card *ngIf="mostrarReglas">
    <ion-card-header>
      <ion-card-title>Reglas para responder el examen</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item>1. Lee cuidadosamente cada pregunta.</ion-item>
        <ion-item>2. Solo puedes seleccionar una opci√≥n por pregunta.</ion-item>
        <ion-item>3. No se puede retroceder a preguntas anteriores.</ion-item>
        <ion-item>4. El tiempo m√°ximo es de 15 minutos.</ion-item>
        <ion-item>5. Tu puntaje se calcular√° al finalizar todas las preguntas.</ion-item>
      </ion-list>
      <ion-button expand="block" color="primary" (click)="comenzarExamen()">Comenzar Examen</ion-button>
    </ion-card-content>
  </ion-card>

  <!-- Spinner mientras carga -->
  <ion-spinner *ngIf="cargando" name="crescent" class="ion-margin"></ion-spinner>

  <!-- Examen en progreso -->
  <ng-container *ngIf="!mostrarReglas && !terminado && preguntas.length > 0 && !cargando">
    <div class="timer-container">
      <p>‚è± Tiempo restante: {{ getTiempo() }}</p>
      <ion-progress-bar [value]="progresoTiempo" color="warning"></ion-progress-bar>
    </div>

    <ion-card>
      <ion-card-header>
        <ion-card-title>
          Pregunta {{ preguntaActual + 1 }} de {{ preguntas.length }}
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <h2>{{ preguntas[preguntaActual].texto }}</h2>

        <ion-list>
          <ion-radio-group
            [value]="respuestasUsuario[preguntas[preguntaActual].id]"
            (ionChange)="responder($event.detail.value)">
            <ion-item *ngFor="let opcion of preguntas[preguntaActual].opciones; let i = index">
              <ion-label>{{ opcion }}</ion-label>
              <ion-radio slot="start" [value]="i"></ion-radio>
            </ion-item>
          </ion-radio-group>
        </ion-list>

        <ion-progress-bar [value]="(preguntaActual + 1) / preguntas.length" color="primary"></ion-progress-bar>

        <ion-button expand="block" color="primary" (click)="siguiente()" [disabled]="!corregida">
          {{ preguntaActual === preguntas.length - 1 ? 'Finalizar' : 'Siguiente' }}
        </ion-button>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- ‚úÖ Resultado Final -->
  <ng-container *ngIf="terminado && !cargando">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Resultado Final: {{ puntaje | number:'1.0-0' }}%</ion-card-title>
      </ion-card-header>
      <ion-card-content>

        <div *ngIf="mostrarFelicitacion" class="felicitacion">
          üéâ ¬°Felicitaciones! Has aprobado con √©xito el examen. üéâ
        </div>

        <ion-list>
          <ion-item *ngFor="let p of preguntas">
            <ion-label>
              <h3>{{ p.texto }}</h3>
              <p><strong>√Årbol:</strong> {{ p.treeId }}</p>
              <ion-list>
                <ion-item *ngFor="let opcion of p.opciones; let i = index"
                          [ngClass]="{
                            'correcta': i === p.correcta,
                            'incorrecta': i === respuestasUsuario[p.id] && i !== p.correcta
                          }">
                  {{ opcion }}
                </ion-item>
              </ion-list>
              <p><em>Explicaci√≥n:</em> {{ p.explicacion }}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-button expand="block" color="success" (click)="reiniciar()">Volver a Reglas</ion-button>
        <ion-button expand="block" color="secondary" (click)="irPerfil()">Ver Perfil</ion-button>
      </ion-card-content>
    </ion-card>
  </ng-container>

</ion-content>
